---
phase: 7
plan: 4
wave: 2
---

# Plan 7.4: Latency Probe

## Objective
Instrument the end-to-end pipeline with timestamps so developers can measure actual delay from Glove vector ingestion → intent match → Ollama generation → TTS play → Flutter UI update.

## Context
- hub/main_server.py (ingest_glove_data loop)
- hub_services MCP Server (if available)

## Tasks

<task type="auto">
  <name>Add timing instrumentation to `main_server.py`</name>
  <files>hub/main_server.py</files>
  <action>
    - At the start of the intent match block in `ingest_glove_data`, record `t_start = time.perf_counter()`.
    - After `broadcast_telemetry` completes (including TTS), record `t_end = time.perf_counter()`.
    - Print a formatted log line: `[Latency Probe] Total pipeline: {(t_end - t_start) * 1000:.1f}ms`.
    - Break down sub-steps: gesture match, ollama generation, tts, broadcast.
  </action>
  <verify>python hub/main_server.py (trigger a gesture and observe latency output)</verify>
  <done>Latency breakdown prints on every intent match.</done>
</task>

<task type="auto">
  <name>Expose latency as MCP Tool</name>
  <files>hub_services MCP server (if it exists)</files>
  <action>
    - If a `hub_services` MCP server exists, add a `latency_probe` tool that triggers a simulated round-trip and returns the measured latency.
  </action>
  <done>MCP tool returns measured latency in ms.</done>
</task>

## Success Criteria
- [ ] Each intent cycle logs a breakdown of all pipeline sub-stages in milliseconds.
